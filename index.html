<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Programming - MD</title>
    <link href="https://fonts.googleapis.com/css2?family=Khand:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/palette.css">
    <link rel="stylesheet" href="styles/minimap.css">
    <link rel="stylesheet" href="styles/topButtons.css">
    <link rel="stylesheet" href="styles/dropdown.css">
    <link rel="stylesheet" href="styles/saveDropdown.css">
    <link rel="stylesheet" href="styles/toast.css">
    <link rel="stylesheet" href="styles/toolbox.css">
    <link rel="stylesheet" href="styles/resizer.css">
    <link rel="stylesheet" href="styles/modal.css">
    <link rel="stylesheet" href="styles/codeModal.css">
    <link rel="stylesheet" href="styles/bluetoothModal.css">
    <link rel="stylesheet" href="styles/variablesPane.css">

    <!-- Prism.js Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />

    <!-- Importing Blockly -->
    <script src="./node_modules/blockly/blockly_compressed.js"></script>
    <script src="./node_modules/blockly/blocks_compressed.js"></script>
    <script src="./node_modules/blockly/javascript_compressed.js"></script>
    <script src="./node_modules/blockly/python_compressed.js"></script>
    <script src="./node_modules/blockly/msg/en.js"></script>
    
    <!-- Importing Blockly Plugins -->
    <script src="./node_modules/@blockly/shadow-block-converter/dist/index.js"></script>
    <script src="./node_modules/@blockly/workspace-minimap/dist/index.js"></script>
    <!-- <script src="./node_modules/@blockly/block-shareable-procedures/dist/index.js"></script> -->
    
    <!-- JS-Interpreter for safe block-by-block execution -->
    <script src="acorn_interpreter.js"></script>
</head>
<body>
    <div id="topBar">
        <div class="left-align">
            <div id="bluetoothButton" class="bluetooth-button-container">
                <button class="bt-main-button">
                    <img src="svg/Bluetooth.svg" class="bt-icon" alt="Bluetooth icon" aria-hidden="true" />
                    <span class="bt-status-badge">Connect</span>
                    <span class="bt-debug-button">üîß</span>
                </button>
            </div>
            <div class="dropdown-container">
                <button id="saveBtn" class="dropdown-button">
                    Save/Load&nbsp;
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div id="saveDropdown" class="dropdown-menu">
                    <div class="dropdown-item" data-action="save-now">Save now</div>
                    <div class="dropdown-item" data-action="export-save">Export save</div>
                    <div class="dropdown-item" data-action="import-save">Import save</div>
                    <div class="dropdown-item warning" data-action="clear-workspace">Clear workspace</div>
                </div>
            </div>
        </div>
        <div class="center-align">
            <button id="codeBtn" class="right-align" data-modal="codeModal">Show as Code</button>
            <button id="toggleVariablesPaneBtn" class="right-align">Variables</button>
        </div>
        <div class="right-align">
            <button id="runBtn" class="right-align">Run Program</button>
            <button id="stopBtn" class="right-align" style="display: none;">Stop Program</button>
        </div>
    </div>

    <div id="blocklyDiv"></div>

    <!-- Toolbox Resizer -->
    <div id="toolboxResizer" class="toolbox-resizer">
        <div class="resizer-handle"></div>
    </div>

    <!-- Variables Pane -->
    <div id="variablesPane" class="variables-pane">
        <div class="variables-header">
            <h3>Variables</h3>
            <button id="refreshVariablesBtn" class="refresh-variables-btn" title="Clear all variables">‚Üª</button>
        </div>
        <div class="variables-content">
            <table id="variablesTable" class="variables-table">
                <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="variablesTableBody">
                    <tr class="no-variables">
                        <td colspan="2">No variables yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modals -->
    <div id="bluetoothModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Bluetooth Debug</h2>
                <span class="close-btn" data-modal="bluetoothModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="bt-debug-container">
                    <div class="bt-debug-column">
                        <div class="bt-tools-section">
                            <h3>Loaded MCP Tools</h3>
                            <div id="btToolsList" class="tools-list">
                                <div class="no-tools">No tools loaded yet</div>
                            </div>
                            <button id="btReloadToolsBtn" class="bt-btn reload-tools-btn">üîÑ Reload MCP Tools</button>
                        </div>
                    </div>
                    
                    <div class="bt-debug-column">
                        <div class="bt-log-section">
                            <h3>Communication Log</h3>
                            <div class="log-controls">
                                <button id="btClearLogBtn" class="bt-btn small-btn">üóëÔ∏è Clear Log</button>
                                <label class="auto-scroll-label">
                                    <input type="checkbox" id="btAutoScrollLog" checked> Auto-scroll
                                </label>
                            </div>
                            <div id="btLog" class="bt-log"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

     <div id="codeModal" class="modal">
        <div class="modal-content modal-auto code-modal-content">
            <div class="modal-header">
                <h2>Code View</h2>
                <span class="close-btn" data-modal="codeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="code-copy-btn">
                    <button id="copyCodeBtn">Copy Code</button>
                    <button id="copySantaBtn">Copy Santa Code</button>
                </div>
                <pre class="line-numbers"><code id="codeOutput" class="language-python"># Placeholder text (no code generation)
                </code></pre>
            </div>
        </div>
     </div>

    <img src="svg/Background.svg" alt="Santa walking in the snow forest" class="background background-santa">
    <img src="svg/Snowflake.svg" alt="Snowflake falling from the sky" class="background background-snowflake">

    <!-- Prism.js Syntax Highlighting Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    
    <script src="scripts/minimapController.js"></script>
    <script src="scripts/topBarController.js"></script>
    <script src="scripts/topBarWidthController.js"></script>
    <script src="scripts/toolboxController.js"></script>
    <script src="scripts/toolboxResizer.js"></script>
    <script src="scripts/modalController.js"></script>
    <script src="scripts/toastController.js"></script>
    <script src="scripts/bluetoothController.js"></script>
    <script src="scripts/saveDropdownController.js"></script>
    <script src="scripts/functionController.js"></script>
    <script src="scripts/customCategory.js"></script>
    <script src="scripts/customBlocks.js"></script>
    <script src="scripts/codeGenerator.js"></script>
    <script src="scripts/interpreter.js"></script>
    <script src="scripts/variablesPaneController.js"></script>
    <script src="scripts/executionController.js"></script>
    <script src="scripts/showCodeModal.js"></script>
    <script src="scripts/debug.js"></script>
    <script src="scripts/blocklySetup.js"></script>
    <script>
        // Run debug after everything is loaded
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.debugCodeGeneration) {
                    console.log('Running automatic debug check...');
                    window.debugCodeGeneration();
                }
            }, 2000); // Wait 2 seconds for everything to initialize
        });
        
        Prism.highlightAll();
    </script>
</body>
</html>